<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>미수행자 조치 기록 보드</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .chip{border:1px solid #e2e8f0;border-radius:9999px;padding:6px 10px;font-size:12px;background:#f8fafc}
    .chip.active{background:#111827;color:#fff;border-color:#111827}
    .sticky-th th{position:sticky;top:0;background:#f8fafc}
  </style>
<style>
/* row dim */
.row-dim{opacity:.55; transition: opacity .2s ease;}
/* 3회 이상 현재 목록 등장 하이라이트 */
.hi3{ color:#dc2626; font-weight:700; }
</style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-7xl mx-auto p-4">
    <header class="mb-4 flex items-center gap-2">
      <a class="px-3 py-2 rounded-lg bg-slate-200 hover:bg-slate-300" href="./index.html">← 메인 대시보드</a>
      <h1 class="text-2xl font-bold">미수행자 조치 기록 보드</h1>
      <span class="ml-auto text-xs text-slate-500">단일 파일 · LocalStorage 저장</span>
    </header>
    <div id="status" class="mb-3 text-sm text-slate-600"></div>

    <!-- 필터 박스 -->
    <section class="mb-4 bg-white rounded-xl shadow p-4">
      <div class="flex flex-wrap items-end gap-4">
        <div>
          <label class="block text-xs font-medium mb-1">시작일</label>
          <input id="startDate" type="date" class="w-44 rounded-lg border-slate-300" />
        </div>
        <div>
          <label class="block text-xs font-medium mb-1">종료일</label>
          <input id="endDate" type="date" class="w-44 rounded-lg border-slate-300" />
        </div>
        <div class="grow">
          <div class="text-xs font-medium mb-1">빠른 선택</div>
          <div class="flex flex-wrap gap-2">
            <button class="chip" id="rngAll">전체</button>
            <button class="chip" id="rngToday">오늘</button>
            <button class="chip" id="rngWeekMon">이번주(월~일)</button>
            <button class="chip" id="rngMonth">이번달</button>
            <button class="chip" id="rngLastWeek">지난주</button>
            <button class="chip" id="rngLastMonth">지난달</button>
          </div>
        </div>
        <div class="ml-auto text-right">
          <div class="text-xs text-slate-500 mb-1">선택된 기간</div>
          <div id="rangeBadge" class="inline-block chip">전체</div>
        </div>
      </div>
    </section>

    <section class="mb-3 bg-white rounded-xl shadow p-4">
      <div class="flex items-center gap-2 flex-wrap">
        <input id="search" placeholder="학생/반/선생님/과목 검색" class="rounded-lg border px-2 py-1 text-sm w-80"/>
        <select id="homeroom" class="rounded-lg border px-2 py-1 text-sm w-52"><option value="">담임: 전체</option></select>
        <button id="btnExport" class="px-3 py-1 rounded bg-indigo-600 text-white text-sm hover:bg-indigo-700">조치기록 CSV 내보내기</button>
        <span class="ml-auto text-sm text-slate-500" id="count"></span>
      </div>
      <div class="mt-3 overflow-auto max-h-[65vh]">
        <table class="min-w-full text-sm">
          <thead class="sticky-th">
            <tr>
              <th class="text-left px-2 py-2">날짜</th>
              <th class="text-left px-2 py-2">학생</th>
              <th class="text-left px-2 py-2">반</th>
              <th class="text-left px-2 py-2">과목</th>
              <th class="text-left px-2 py-2">선생님</th>
              <th class="text-left px-2 py-2">상태</th>
              <th class="text-left px-2 py-2">조치</th>
              <th class="text-left px-2 py-2">최종확인</th>
              <th class="text-left px-2 py-2">기록</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <section class="bg-white rounded-xl shadow p-4">
      <h2 class="font-semibold mb-3">학생별 요약</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="summary"></div>
    </section>

    <!-- 데이터 업로드 / 로딩 -->
    <div class="fixed bottom-4 right-4">
      <div class="bg-white rounded-xl shadow-lg p-3 flex items-center gap-2">
        <input type="file" accept=".xlsx,.csv" id="fileInput" class="block text-sm" />
        <label class="inline-flex items-center gap-1 text-xs">
          <input id="autoLoad" type="checkbox" class="rounded border" />
          자동불러오기
        </label>
        <button id="clearSaved" class="px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 text-xs">저장삭제</button>
      </div>
    </div>
  </div>

<script>
// ===== 설정 =====
const LS_KEYS = {
  autoload: 'lancon_autoload',
  data: 'lancon_data_json',       // 메인과 공유
  savedAt: 'lancon_saved_at',
  actions: 'lancon_interventions_v2' // 이 페이지 전용: 조치 기록
};

let RAW = [];      // 메인 데이터
let ACTIONS = [];  // 조치 기록

// ===== 유틸 =====
function fmtYMD(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${da}`}
function parseDate(val){
  if(val==null) return null;
  if(typeof val==='number'){ try{const d=XLSX.SSF.parse_date_code(val);return new Date(d.y,d.m-1,d.d);}catch{return null;} }
  const s=String(val).trim().replace(/[.\/]/g,'-');
  const m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
  if(m){return new Date(+m[1],+m[2]-1,+m[3]);}
  const d=new Date(s);return isNaN(d)?null:new Date(d.getFullYear(),d.getMonth(),d.getDate());
}
function normalizeStatus(v){
  const s=String(v||'').trim();
  if(/과제안함/.test(s)) return '미수행';
  if(/해당없음/.test(s)) return '제외';
  if(/^\d+$/.test(s)) return '수행';
  return '기타';
}
function mapRecord(r){
  const clean={};
  for(const k in r){const nk=String(k).replace(/\ufeff/g,'').trim();const v=r[k];clean[nk]=(typeof v==='string')?v.trim():v;}
  const obj={
    '날짜':clean['날짜']??clean['date']??clean['Date']??'',
    '작성자':clean['작성자']??clean['선생님']??clean['Teacher']??'',
    '과목':clean['과목']??clean['제목']??clean['유형']??clean['subject']??'',
    '반코드':clean['반코드']??clean['반명']??clean['반']??clean['class']??'',
    '학생명':clean['학생명']??clean['학생']??clean['이름']??clean['student']??'',
    '상태':clean['상태']??clean['구분']??clean['점수']??clean['점수/비고']??''
  };
  for(const k in obj){if(typeof obj[k]==='string') obj[k]=obj[k].trim();}
  return obj;
}

// ===== LocalStorage =====
function saveActions(){ localStorage.setItem(LS_KEYS.actions, JSON.stringify(ACTIONS)); }
function loadActions(){ try{ const s=localStorage.getItem(LS_KEYS.actions); ACTIONS = s? JSON.parse(s): []; }catch{ ACTIONS=[]; } }
function saveData(rows){ localStorage.setItem(LS_KEYS.data, JSON.stringify(rows)); localStorage.setItem(LS_KEYS.savedAt, new Date().toISOString()); }
function loadDataFromLocal(){
  const flag = localStorage.getItem(LS_KEYS.autoload)==='1';
  document.getElementById('autoLoad').checked = flag;
  const json=localStorage.getItem(LS_KEYS.data);
  if(flag && json){ try{ const rows=JSON.parse(json); if(Array.isArray(rows) && rows.length){ RAW=rows; return true; } }catch{} }
  return false;
}
function clearLocal(){ localStorage.removeItem(LS_KEYS.data); localStorage.removeItem(LS_KEYS.savedAt); localStorage.removeItem(LS_KEYS.actions); }

// ===== 파일 파싱/로드 =====
async function parseFile(file){
  const isCSV=/\.csv$/i.test(file.name||'');
  try{
    if(isCSV){
      const text=await file.text();
      let json=readCSVText(text);
      if(!json||!json.length){ const buf=await file.arrayBuffer(); json=readArray(buf,949)||readArray(buf,51949)||readArray(buf); }
      return json||[];
    }else{ const buf=await file.arrayBuffer(); return readArray(buf)||[]; }
  }catch(e){ const buf=await file.arrayBuffer(); return readArray(buf)||[]; }
}
function readCSVText(text){
  try{
    const lines=text.split(/\r?\n/); const first=lines.find(l=>l.trim().length>0)||'';
    const cnt={comma:(first.match(/,/g)||[]).length, tab:(first.match(/\t/g)||[]).length, semi:(first.match(/;/g)||[]).length};
    let normalized=text; if(cnt.tab>cnt.comma && cnt.tab>=cnt.semi) normalized=text.replace(/\t/g, ','); else if(cnt.semi>cnt.comma && cnt.semi>cnt.tab) normalized=text.replace(/;/g, ','); 
    const wb=XLSX.read(normalized,{type:'string'}); const ws=wb.Sheets[wb.SheetNames[0]]; return XLSX.utils.sheet_to_json(ws,{defval:'',raw:false});
  }catch{return null;}
}
function readArray(buf,codepage){ try{ const opts={type:'array'}; if(codepage) opts.codepage=codepage; const wb=XLSX.read(buf,opts); const ws=wb.Sheets[wb.SheetNames[0]]; return XLSX.utils.sheet_to_json(ws,{defval:'',raw:false}); }catch{return null;}}
async function loadFromServer() {
  try {
    const res = await fetch('example01.csv');   // 같은 폴더에 있을 때
    const text = await res.text();
    const wb = XLSX.read(text, { type: 'string' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, { defval:'', raw:false });
    RAW = (json || []).map(mapRecord).filter(r =>
      Object.values(r).some(v => String(v ?? '').trim() !== '')
    );
    renderAll();
  } catch (e) {
    console.warn('서버 데이터 로드 실패', e);
  }
}

// ===== 범위/필터 =====
function getRange(){ const sd=startDate.value, ed=endDate.value; const s=sd? new Date(sd+'T00:00:00'):null; const e=ed? new Date(ed+'T23:59:59.999'):null; return {s,e}; }
function inRange(d,{s,e}){ if(!d) return false; if(s&&d<s) return false; if(e&&d>e) return false; return true; }
function updateBadge(){ const sd=startDate.value, ed=endDate.value; const b=document.getElementById('rangeBadge'); b.textContent= (!sd&&!ed)? '전체' : `${sd||'..'} ~ ${ed||'..'}`; }
function setRange(s,e){ startDate.value=s?fmtYMD(s):''; endDate.value=e?fmtYMD(e):''; updateBadge(); renderAll(); }
function bindRangeChips(){
  const today=new Date();
  rngAll.onclick=()=>{ setRange(null,null); actChip(rngAll); };
  rngToday.onclick=()=>{ setRange(today,today); actChip(rngToday); };
  rngWeekMon.onclick=()=>{ const d=new Date(); const day=(d.getDay()+6)%7; const s=new Date(d); s.setDate(d.getDate()-day); const e=new Date(s); e.setDate(s.getDate()+6); setRange(s,e); actChip(rngWeekMon); };
  rngMonth.onclick=()=>{ const d=new Date(); const s=new Date(d.getFullYear(),d.getMonth(),1); const e=new Date(d.getFullYear(),d.getMonth()+1,0); setRange(s,e); actChip(rngMonth); };
  rngLastWeek.onclick=()=>{ const d=new Date(); const day=(d.getDay()+6)%7; const e=new Date(d); e.setDate(d.getDate()-day-1); const s=new Date(e); s.setDate(e.getDate()-6); setRange(s,e); actChip(rngLastWeek); };
  rngLastMonth.onclick=()=>{ const d=new Date(); const s=new Date(d.getFullYear(),d.getMonth()-1,1); const e=new Date(d.getFullYear(),d.getMonth(),0); setRange(s,e); actChip(rngLastMonth); };
}
function actChip(el){ document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); el?.classList.add('active'); }

// ===== 키 & 조치 모델 =====
function makeKey(r){ const d=parseDate(r['날짜']); return [d?fmtYMD(d):'', r['학생명']||'', r['반코드']||'', r['과목']||''].join('|'); }
function getActionByKey(key){ return ACTIONS.find(a=>a.key===key); }
function upsertAction(rec){
  const i=ACTIONS.findIndex(a=>a.key===rec.key);
  if(i>=0) ACTIONS[i]=rec; else ACTIONS.push(rec);
  saveActions();
}

// ===== 렌더: 본표 =====
function renderTable(){
  const range=getRange();
  let rows = RAW.filter(r=> normalizeStatus(r['상태'])==='미수행' && inRange(parseDate(r['날짜']), range));
  const q=(search.value||'').trim().toLowerCase();
  if(q) rows = rows.filter(r=> `${r['학생명']} ${r['반코드']} ${r['작성자']} ${r['과목']}`.toLowerCase().includes(q) );
  const hrSel = document.getElementById('homeroom');
  const hr = hrSel ? (hrSel.value||'') : '';
  if(hr) rows = rows.filter(r=> String((r['담임']&&String(r['담임']).trim())? r['담임'] : (r['작성자']||'')) === hr);
  rows.sort((a,b)=> (parseDate(b['날짜'])-parseDate(a['날짜'])) || String(a['학생명']||'').localeCompare(String(b['학생명']||'')) );
  const nameCount = rows.reduce((m,r)=>{ const n=r['학생명']||''; if(n) m[n]=(m[n]||0)+1; return m; },{});
  const tbody=document.getElementById('tbody'); tbody.innerHTML='';
  rows.forEach(r=>{
    const key = makeKey(r);
    const act = getActionByKey(key) || { key, action:'', resolved:false, confirmedAt:'' };
    const tr=document.createElement('tr'); tr.className='hover:bg-slate-50';
    tr.innerHTML = `
      <td class="px-2 py-1">${fmtYMD(parseDate(r['날짜']))}</td>
      <td class="px-2 py-1 ${ (nameCount[r['학생명']]||0) >= 3 ? 'hi3' : '' }">${r['학생명']||''}${ (nameCount[r['학생명']]||0) >= 3 ? '<span class="ml-1 inline-block text-[10px] px-1 py-0.5 rounded bg-red-50 text-red-600 border border-red-200">3회↑</span>' : '' }</td>
      <td class="px-2 py-1">${r['반코드']||'(미지정)'}</td>
      <td class="px-2 py-1">${r['과목']||'(미지정)'}</td>
      <td class="px-2 py-1">${r['작성자']||''}</td>
      <td class="px-2 py-1">${r['상태']||''}</td>
      <td class="px-2 py-1">${renderActionSelect(act.action)}</td>
      <td class="px-2 py-1 text-center"><input type="checkbox"/></td>
      <td class="px-2 py-1"><button class="px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 text-xs">저장</button></td>

    `;
    const [sel, chk, btn] = [
      tr.querySelector('select'),
      tr.querySelector('input[type="checkbox"]'),
      tr.querySelector('button')
    ];
    // instant dim on toggle (actual timestamp saved on '저장')
    chk.onchange = ()=>{ tr.classList.toggle('row-dim', chk.checked); };
    btn.onclick = ()=>{
      const rec={ key, action: sel.value, resolved: chk.checked };
      upsertAction(rec); btn.textContent='저장됨'; setTimeout(()=> btn.textContent='저장', 1200);
      renderSummary(); // 요약 갱신
    };
    tbody.appendChild(tr);
  });
  count.textContent = `${rows.length}건`;
  try{ const hrS = document.getElementById('homeroom'); const hr = hrS ? (hrS.value||'') : ''; if(hr){ count.textContent += ` · 담임: ${hr}`; } }catch{}
}
function renderActionSelect(value){ const options=['','나머지','다음 시간 제출','학생 상담','학부모 상담'];
  return `<select class="rounded border text-sm">${options.map(o=>`<option value="${o}" ${o===value?'selected':''}>${o||'- 조치 선택 -'}</option>`).join('')}</select>`;
}

// ===== 렌더: 학생별 요약 =====
function rate(done,miss){ return Math.round((done/((done+miss)||1))*100); }
function renderSummary(){
  // hide the summary section if homeroom selected
  try{
    const hrSel = document.getElementById('homeroom');
    const selectedHR = hrSel ? (hrSel.value||'') : '';
    const wrap=document.getElementById('summary');
    const section = wrap?.closest('section');
    if(selectedHR){ if(section) section.style.display='none'; wrap.innerHTML=''; return; }
    if(section) section.style.display='block';
  }catch{}

  // === NEW: show only when searching student name ===
  try{
    const searchEl = document.getElementById('search');
    const q = (searchEl?.value || '').trim().toLowerCase();
    const wrap2 = document.getElementById('summary');
    const section2 = wrap2?.closest('section');
    if(!q){ if(section2) section2.style.display='none'; wrap2.innerHTML=''; return; }
  }catch{}

  const range=getRange();
  const wrap=document.getElementById('summary'); wrap.innerHTML='';
  const allNames=[...new Set(RAW.map(r=>r['학생명']).filter(Boolean))].sort();
  const q=(document.getElementById('search')?.value||'').trim().toLowerCase();
  const names=allNames.filter(n=> String(n).toLowerCase().includes(q));
  names.forEach(name=>{
    const mine=RAW.filter(r=> r['학생명']===name && inRange(parseDate(r['날짜']), range));
    const done=mine.filter(r=> normalizeStatus(r['상태'])==='수행').length;
    const miss=mine.filter(r=> normalizeStatus(r['상태'])==='미수행').length;
    if(done+miss===0) return;
    const r= rate(done,miss);
    const misses=mine.filter(rm=> normalizeStatus(rm['상태'])==='미수행')
                     .sort((a,b)=> parseDate(b['날짜'])-parseDate(a['날짜'])).slice(0,10);
    const card=document.createElement('div'); card.className='p-4 bg-white rounded-xl shadow';
    card.innerHTML=`
      <div class="flex items-center justify-between mb-2">
        <div>
          <h3 class="font-semibold text-lg">${name}</h3>
          <div class="text-sm text-slate-600">수행 ${done} · 미수행 ${miss} · 수행률 ${r}%</div>
        </div>
        <button class="px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 text-xs">미수행만 보기</button>
      </div>
      <div class="text-sm max-h-40 overflow-auto border rounded">
        <table class="min-w-full text-sm">
          <thead class="sticky-th"><tr><th class="text-left px-2 py-1">날짜</th><th class="text-left px-2 py-1">반</th><th class="text-left px-2 py-1">과목</th><th class="text-left px-2 py-1">선생님</th><th class="text-left px-2 py-1">조치</th><th class="text-left px-2 py-1">최종확인</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    `;
    const tbody=card.querySelector('tbody');
    misses.forEach(rm=>{
      const key=makeKey(rm); const act=getActionByKey(key);
      const tr=document.createElement('tr'); tr.innerHTML=`
        <td class="px-2 py-1">${fmtYMD(parseDate(rm['날짜']))}</td>
        <td class="px-2 py-1">${rm['반코드']||''}</td>
        <td class="px-2 py-1">${rm['과목']||''}</td>
        <td class="px-2 py-1">${rm['작성자']||''}</td>
        <td class="px-2 py-1">${act?.action||''}</td>
        <td class="px-2 py-1">${act?.resolved?'최종확인':''}</td>
      `; tbody.appendChild(tr);
    });
    card.querySelector('button').onclick=()=>{
      document.getElementById('search').value=name; renderAll();
    };
    wrap.appendChild(card);
  });
}

// ===== 내보내기/가져오기 =====
function exportCSV(){
  const header=['key','action','resolved'];
  const rows=ACTIONS.map(a=>({ key:a.key, action:a.action, resolved:a.resolved?1:0 }));
  const ws=XLSX.utils.json_to_sheet(rows,{header});
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'interventions');
  const out=XLSX.write(wb,{type:'array',bookType:'csv'});
  const blob=new Blob([out],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='interventions.csv'; a.click(); URL.revokeObjectURL(url);
}

// ===== 렌더 드라이버 =====
function renderAll(){
  try{
    // homeroom select populate
    const sel = document.getElementById('homeroom');
    if(sel){
      const uniq = Array.from(new Set((RAW||[]).map(r=> (r['담임']&&String(r['담임']).trim())? r['담임'] : (r['작성자']||'')).filter(v=> String(v||'').trim()!==''))).sort((a,b)=> String(a).localeCompare(String(b)));
      const cur = sel.value;
      sel.innerHTML = '<option value="">담임: 전체</option>' + uniq.map(v=> `<option value="${v}">${v}</option>`).join('');
      if(uniq.includes(cur)) sel.value = cur;
    }
  }catch{}
 renderTable(); renderSummary(); }

// ===== 초기 바인딩 =====
function bindApp(){

  // 보조 안전장치: 담임(선생님) 셀렉터가 없으면 즉석 생성
  (function ensureHomeroomSelect(){
    try{
      if(!document.getElementById('homeroom')){
        const searchEl = document.getElementById('search');
        if(searchEl && searchEl.parentElement){
          const sel = document.createElement('select');
          sel.id = 'homeroom';
          sel.className = 'rounded-lg border px-2 py-1 text-sm w-52';
          sel.innerHTML = '<option value="">담임: 전체</option>';
          searchEl.insertAdjacentElement('afterend', sel);
          sel.onchange = ()=>{ renderAll(); try{ document.querySelector('table').scrollIntoView({behavior:'smooth', block:'start'}); }catch{} };
          const st = document.getElementById('status');
          if(st) st.textContent = (st.textContent? st.textContent+' · ' : '') + '담임 선택란을 생성했습니다.';
        }
      } else {
        // 존재하는 경우에도 보이도록 강제
        const sel = document.getElementById('homeroom');
        sel.style.display = '';
      }
    }catch(e){ console.warn('ensureHomeroomSelect failed', e); }
  })();

  // 범위
  startDate.onchange=()=>{ updateBadge(); renderAll(); };
  endDate.onchange=()=>{ updateBadge(); renderAll(); };
  bindRangeChips(); updateBadge();
  // 검색 & 담임 필터
  search.oninput=renderAll;
  const hrSel = document.getElementById('homeroom'); if(hrSel){ hrSel.onchange=()=>{ renderAll(); try{ document.querySelector('table').scrollIntoView({behavior:'smooth', block:'start'}); }catch{} }; }
  // 우측 로더
  autoLoad.onchange=()=>{ localStorage.setItem(LS_KEYS.autoload, autoLoad.checked?'1':'0'); };
  clearSaved.onclick=()=>{ clearLocal(); alert('저장된 데이터(메인+조치기록)를 삭제했습니다.'); };
  fileInput.onchange= async (e)=>{
    const f=e.target.files[0]; if(!f) return; const parsed=await parseFile(f);
    RAW=(parsed||[]).map(mapRecord).filter(r=> Object.values(r).some(v=> String(v??'').trim()!==''));
    renderAll(); if(autoLoad.checked){ saveData(RAW); }
  };
  btnExport.onclick=exportCSV; 

  // 데이터 불러오기
  loadActions();
  if (!loadDataFromLocal()) {
    loadFromServer();
  }
  renderAll();
}

document.addEventListener('DOMContentLoaded', bindApp);
</script>
</body>
</html>