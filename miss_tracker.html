<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>미수행 학생 관리 (miss_tracker)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    .chip{border:1px solid #e2e8f0;border-radius:9999px;padding:6px 10px;font-size:12px;background:#f8fafc}
    .chip.active{background:#111827;color:#fff;border-color:#111827}
    .sticky-th th{position:sticky;top:0;background:#f8fafc}
    .risk{background:#fff7ed}
    .badge{display:inline-block;padding:2px 8px;border-radius:9999px;font-size:11px;border:1px solid #e5e7eb}
    .badge-rose{background:#fff1f2;color:#e11d48;border-color:#fecdd3}
    .badge-amber{background:#fff7ed;color:#b45309;border-color:#fed7aa}
    .badge-green{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
<div class="max-w-7xl mx-auto p-4">

  <!-- 헤더 -->
  <header class="mb-4 flex items-center gap-2">
    <a class="px-3 py-2 rounded-lg bg-slate-200 hover:bg-slate-300" href="./index.html">← 메인 대시보드</a>

    <!-- 인쇄 버튼 -->
    <button id="btnPrintMiss"
      class="px-3 py-2 rounded-lg bg-rose-600 text-white text-sm hover:bg-rose-700 ml-1">
      미수행 인쇄
    </button>

    <h1 class="text-2xl font-bold ml-3">미수행 학생 관리</h1>
    <span class="ml-2 text-xs text-slate-500">담임 입력은 빠르게 · 관리자는 한눈에</span>

    <div class="ml-auto flex items-center gap-2 text-sm">
      <label class="inline-flex items-center gap-1">
        <input id="autoLoad" type="checkbox" class="rounded"/> 자동불러오기
      </label>
      <button id="clearSaved" class="px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 text-xs">저장삭제</button>
    </div>
  </header>

  <!-- 상단 바 -->
  <section class="mb-4 bg-white rounded-xl shadow p-4">
    <div class="flex flex-wrap items-end gap-3">
      <div>
        <label class="block text-xs font-medium mb-1">시작일</label>
        <input id="startDate" type="date" class="w-44 rounded-lg border-slate-300" />
      </div>

      <div>
        <label class="block text-xs font-medium mb-1">종료일</label>
        <input id="endDate" type="date" class="w-44 rounded-lg border-slate-300" />
      </div>

      <div class="grow">
        <div class="text-xs font-medium mb-1">빠른 선택</div>
        <div class="flex flex-wrap gap-2">
          <button class="chip" id="rngAll">전체</button>
          <button class="chip" id="rngToday">오늘</button>
          <button class="chip" id="rngWeekMon">이번주(월~일)</button>
          <button class="chip" id="rngMonth">이번달</button>
          <button class="chip" id="rngLastWeek">지난주</button>
          <button class="chip" id="rngLastMonth">지난달</button>
        </div>
      </div>

      <div>
        <label class="block text-xs font-medium mb-1">모드</label>
        <select id="mode" class="rounded-lg border px-2 py-1 text-sm w-44">
          <option value="teacher">담임용 입력</option>
          <option value="admin">관리자 대시보드</option>
        </select>
      </div>

      <div>
        <label class="block text-xs font-medium mb-1">담임 선택(담임용)</label>
        <select id="homeroom" class="rounded-lg border px-2 py-1 text-sm w-52">
          <option value="">담임: 전체</option>
        </select>
      </div>

      <div class="ml-auto text-right">
        <div class="text-xs text-slate-500 mb-1">선택된 기간</div>
        <div id="rangeBadge" class="inline-block chip">전체</div>
      </div>
    </div>
  </section>

  <!-- KPI -->
  <section id="kpiBox" class="mb-4 grid grid-cols-2 md:grid-cols-4 gap-3">
    <div class="p-4 bg-white rounded-xl shadow">
      <div class="text-sm text-slate-500">미수행 건수</div>
      <div id="kpiMiss" class="text-2xl font-bold">0</div>
    </div>

    <div class="p-4 bg-white rounded-xl shadow">
      <div class="text-sm text-slate-500">조치 필요</div>
      <div id="kpiOpen" class="text-2xl font-bold">0</div>
    </div>

    <div class="p-4 bg-white rounded-xl shadow">
      <div class="text-sm text-slate-500">확인 완료</div>
      <div id="kpiResolved" class="text-2xl font-bold">0</div>
    </div>

    <div class="p-4 bg-white rounded-xl shadow">
      <div class="text-sm text-slate-500">관리 필요(≤70%)</div>
      <div id="kpiRisk" class="text-2xl font-bold">0</div>
    </div>
  </section>

  <!-- 담임용 입력 -->
  <section id="page-teacher" class="bg-white rounded-xl shadow p-4">
    <div class="flex items-center gap-2 flex-wrap">
      <input id="searchTeacher" placeholder="학생/반/과목 검색" class="rounded-lg border px-2 py-1 text-sm w-80"/>
      <label class="inline-flex items-center gap-1 text-xs ml-auto">
        <span class="kbd">Enter</span> 저장 · <span class="kbd">Alt</span>+<span class="kbd">C</span> 확인 토글
      </label>
    </div>

    <div class="mt-3 overflow-auto max-h-[70vh]">
      <table class="min-w-full text-sm">
        <thead class="sticky-th">
          <tr>
            <th class="text-left px-2 py-2">날짜</th>
            <th class="text-left px-2 py-2">학생</th>
            <th class="text-left px-2 py-2">반</th>
            <th class="text-left px-2 py-2">과목</th>
            <th class="text-left px-2 py-2">조치</th>
            <th class="text-left px-2 py-2">확인</th>
            <th class="text-left px-2 py-2">메모</th>
            <th class="text-left px-2 py-2">저장</th>
          </tr>
        </thead>
        <tbody id="tbodyTeacher"></tbody>
      </table>
    </div>
  </section>

  <!-- 관리자 화면 -->
  <section id="page-admin" class="hidden bg-white rounded-xl shadow p-4">
    <div class="flex items-center gap-2 flex-wrap">
      <input id="searchAdmin" placeholder="학생/반/과목/담임 검색" class="rounded-lg border px-2 py-1 text-sm w-80"/>
      <select id="filterStatus" class="rounded-lg border px-2 py-1 text-sm w-44">
        <option value="all">표시: 전체</option>
        <option value="open">표시: 미확인</option>
        <option value="resolved">표시: 확인완료</option>
      </select>
      <button id="btnExport" class="px-3 py-1 rounded bg-indigo-600 text-white text-sm hover:bg-indigo-700">
        조치기록 CSV 내보내기
      </button>

      <label class="ml-auto inline-flex items-center gap-2 text-xs">
        조치 기록 불러오기
        <input id="importInterventions" type="file" accept=".csv,.xlsx" class="text-xs"/>
      </label>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
      <div class="p-4 rounded-xl border">
        <h3 class="font-semibold mb-2">관리 필요(수행률 ≤ 70%)</h3>
        <ul id="riskList" class="space-y-1 text-sm"></ul>
      </div>

      <div class="p-4 rounded-xl border md:col-span-2">
        <h3 class="font-semibold mb-2">최근 조치 타임라인</h3>
        <div id="timeline" class="space-y-2 text-sm max-h-[300px] overflow-auto"></div>
      </div>
    </div>

    <div class="mt-4 overflow-auto max-h-[50vh]">
      <table class="min-w-full text-sm">
        <thead class="sticky-th">
          <tr>
            <th class="text-left px-2 py-2">기록일시</th>
            <th class="text-left px-2 py-2">날짜</th>
            <th class="text-left px-2 py-2">학생</th>
            <th class="text-left px-2 py-2">반</th>
            <th class="text-left px-2 py-2">과목</th>
            <th class="text-left px-2 py-2">담임</th>
            <th class="text-left px-2 py-2">조치</th>
            <th class="text-left px-2 py-2">확인</th>
            <th class="text-left px-2 py-2">메모</th>
          </tr>
        </thead>
        <tbody id="tbodyAdmin"></tbody>
      </table>
    </div>
  </section>

  <!-- 하단 업로드 -->
  <div class="fixed bottom-4 right-4">
    <div class="bg-white rounded-xl shadow-lg p-3 flex items-center gap-2">
      <input type="file" accept=".xlsx,.csv" id="fileInput" class="block text-sm" />
      <button id="btnReloadExample" class="px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 text-xs">
        예시 불러오기
      </button>
    </div>
  </div>

</div> <!-- END main wrapper -->

<script>
let RAW = [];
let ACTIONS = [];

const LS_KEYS = {
  autoload: 'lancon_autoload',
  data:     'lancon_data_json',
  actions:  'lancon_interventions_v3'
};

/* 공통 유틸 */
function fmtYMD(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const da=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}

function parseDate(val){
  if(val==null) return null;
  if(typeof val==='number'){
    try{
      const d=XLSX.SSF.parse_date_code(val);
      return new Date(d.y,d.m-1,d.d);
    }catch{return null;}
  }
  const s=String(val).trim().replace(/[.\/]/g,'-');
  const m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
  if(m) return new Date(+m[1],+m[2]-1,+m[3]);
  const d=new Date(s);
  return isNaN(d)?null:new Date(d.getFullYear(),d.getMonth(),d.getDate());
}

function normalizeStatus(v){
  const s=String(v||'').trim();
  if(/과제안함/.test(s)) return '미수행';
  if(/해당없음/.test(s)) return '제외';
  if(/^\d+$/.test(s)) return '수행';
  return '기타';
}

function rate(done,miss){
  return Math.round((done/((done+miss)||1))*100);
}

/* 기간 */
function getRange(){
  const sd=document.getElementById('startDate').value;
  const ed=document.getElementById('endDate').value;
  return {
    s: sd? new Date(sd+"T00:00:00") : null,
    e: ed? new Date(ed+"T23:59:59") : null
  };
}

function inRangeDate(d){
  const {s,e}=getRange();
  if(!d) return false;
  if(s && d<s) return false;
  if(e && d>e) return false;
  return true;
}

function updateBadge(){
  const sd=document.getElementById('startDate').value;
  const ed=document.getElementById('endDate').value;
  const b=document.getElementById('rangeBadge');
  b.textContent=(!sd && !ed)?'전체':`${sd||'..'} ~ ${ed||'..'}`;
}

function saveRange(){
  localStorage.setItem('lancon_range_start', document.getElementById('startDate').value);
  localStorage.setItem('lancon_range_end',   document.getElementById('endDate').value);
}

/* CSV 매핑 */
function mapRecord(r){
  const clean={};
  for(const k in r){
    const nk=String(k).replace(/\ufeff/g,'').trim();
    const v=r[k];
    clean[nk]=(typeof v==='string')?v.trim():v;
  }
  return {
    '날짜':   clean['날짜']??clean['date']??clean['Date']??'',
    '작성자': clean['작성자']??clean['선생님']??clean['Teacher']??'',
    '과목':   clean['과목']??clean['제목']??clean['유형']??clean['subject']??'',
    '반코드': clean['반코드']??clean['반명']??clean['반']??clean['class']??'',
    '학생명': clean['학생명']??clean['학생']??clean['이름']??clean['student']??'',
    '상태':   clean['상태']??clean['구분']??clean['점수']??clean['점수/비고']??''
  };
}

/* 저장/불러오기 */
function loadActions(){
  try{
    const s=localStorage.getItem(LS_KEYS.actions);
    ACTIONS=s?JSON.parse(s):[];
  }catch{ACTIONS=[];}
}

function saveActions(){
  localStorage.setItem(LS_KEYS.actions, JSON.stringify(ACTIONS));
}

function saveToLocal(rows){
  try{
    localStorage.setItem(LS_KEYS.data, JSON.stringify(rows));
  }catch(e){}
}

function loadFromLocal(){
  const flag=localStorage.getItem(LS_KEYS.autoload)==='1';
  document.getElementById('autoLoad').checked=flag;
  if(!flag) return false;

  const txt=localStorage.getItem(LS_KEYS.data);
  if(!txt) return false;

  try{
    const rows=JSON.parse(txt);
    if(Array.isArray(rows)&&rows.length){
      RAW=rows;
      return true;
    }
  }catch{}
  return false;
}

/* 파일 읽기 */
function readCSVText(text){
  try{
    const lines=text.split(/\r?\n/);
    const first=lines.find(l=>l.trim().length>0)||'';
    const cnt={
      comma:(first.match(/,/g)||[]).length,
      tab:(first.match(/\t/g)||[]).length,
      semi:(first.match(/;/g)||[]).length
    };
    let normalized=text;
    if(cnt.tab>cnt.comma && cnt.tab>=cnt.semi)
      normalized=text.replace(/\t/g,',');
    else if(cnt.semi>cnt.comma && cnt.semi>cnt.tab)
      normalized=text.replace(/;/g,',');

    const wb=XLSX.read(normalized,{type:'string'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(ws,{defval:'',raw:false});
  }catch{return null;}
}

function readArray(buf,codepage){
  try{
    const opt={type:'array'};
    if(codepage) opt.codepage=codepage;
    const wb=XLSX.read(buf,opt);
    const ws=wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(ws,{defval:'',raw:false});
  }catch{return null;}
}

async function parseFile(file){
  const isCSV=/\.csv$/i.test(file.name||'');
  try{
    if(isCSV){
      const text=await file.text();
      let json=readCSVText(text);
      if(!json||!json.length){
        const buf=await file.arrayBuffer();
        json=readArray(buf,949)||readArray(buf,51949)||readArray(buf);
      }
      return json||[];
    }else{
      const buf=await file.arrayBuffer();
      return readArray(buf)||[];
    }
  }catch{
    const buf=await file.arrayBuffer();
    return readArray(buf)||[];
  }
}

async function loadFromServer(){
  try{
    const res=await fetch('example01.csv');
    const text=await res.text();
    const wb=XLSX.read(text,{type:'string'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const json=XLSX.utils.sheet_to_json(ws,{defval:'',raw:false});
    RAW=(json||[]).map(mapRecord)
         .filter(r=>Object.values(r).some(v=>String(v??'').trim()!==''));
    saveToLocal(RAW);
    renderAll();
  }catch(e){}
}

/* 조치 key */
function makeKey(r){
  const d=parseDate(r['날짜']);
  return [
    d?fmtYMD(d):'',
    r['학생명']||'',
    r['반코드']||'',
    r['과목']||''
  ].join('|');
}

function getActionByKey(key){
  return ACTIONS.find(a=>a.key===key);
}

function upsertAction(rec){
  const i=ACTIONS.findIndex(a=>a.key===rec.key);
  if(i>=0) ACTIONS[i]=rec;
  else ACTIONS.push(rec);
  saveActions();
}

/* 학생별 수행률 */
function buildStudentRates(){
  const map={};
  for(const r of RAW){
    const d=parseDate(r['날짜']);
    if(!inRangeDate(d)) continue;
    const nm=r['학생명']||'';
    if(!nm) continue;
    const st=normalizeStatus(r['상태']);
    map[nm] ??= {done:0,miss:0,classes:new Set(),teachers:new Set()};
    if(st==='수행')   map[nm].done++;
    if(st==='미수행') map[nm].miss++;
    if(r['반코드']) map[nm].classes.add(r['반코드']);
    if(r['작성자']) map[nm].teachers.add(r['작성자']);
  }
  return Object.entries(map).map(([name,v])=>({
    name,
    done:v.done,
    miss:v.miss,
    rate:rate(v.done,v.miss),
    classes:[...v.classes],
    teachers:[...v.teachers]
  }));
}

/* 담임 화면 */
function renderTeacher(){
  const tbody=document.getElementById('tbodyTeacher');
  tbody.innerHTML='';

  const q=(document.getElementById('searchTeacher').value||'').trim().toLowerCase();
  const hr=document.getElementById('homeroom').value;

  localStorage.setItem('lancon_selected_teacher', hr||'');
  saveRange();

  let rows=RAW.filter(r=> normalizeStatus(r['상태'])==='미수행' &&
                           inRangeDate(parseDate(r['날짜'])));

  if(hr) rows=rows.filter(r=>r['작성자']===hr);
  if(q)  rows=rows.filter(r=>`${r['학생명']} ${r['반코드']} ${r['과목']}`.toLowerCase().includes(q));

  rows.sort((a,b)=> (parseDate(b['날짜'])-parseDate(a['날짜'])) ||
                    String(a['학생명']||'').localeCompare(String(b['학생명']||'')));

  const rates=buildStudentRates().reduce((m,o)=>{m[o.name]=o;return m;},{});

  rows.forEach(r=>{
    const key=makeKey(r);
    const act=getActionByKey(key) || {key,action:'',resolved:false,memo:'',who:hr||'',ts:''};
    const stRate=rates[r['학생명']]?.rate ?? null;
    const tr=document.createElement('tr');
    if(stRate!==null && stRate<=70) tr.classList.add('risk');

    tr.innerHTML=`
      <td class="px-2 py-1">${fmtYMD(parseDate(r['날짜']))}</td>
      <td class="px-2 py-1">
        ${r['학생명']||''}
        ${stRate!==null ? `<span class="badge ${stRate<=70?'badge-rose':'badge-green'} ml-1">${stRate}%</span>`:''}
      </td>
      <td class="px-2 py-1">${r['반코드']}</td>
      <td class="px-2 py-1">${r['과목']}</td>
      <td class="px-2 py-1">
        <select class="rounded border px-1 py-1 text-sm">
          <option value="" ${act.action===''?'selected':''}>-</option>
          <option value="수업중 처리" ${act.action==='수업중 처리'?'selected':''}>수업중 처리</option>
          <option value="detention" ${act.action==='detention'?'selected':''}>detention</option>
          <option value="재부과" ${act.action==='재부과'?'selected':''}>재부과</option>
        </select>
      </td>
      <td class="px-2 py-1 text-center"><input type="checkbox" ${act.resolved?'checked':''}></td>
      <td class="px-2 py-1"><input type="text" class="w-64 rounded border px-2 py-1" value="${act.memo}"></td>
      <td class="px-2 py-1"><button class="px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 text-xs">저장</button></td>
    `;

    const sel  = tr.querySelector('select');
    const chk  = tr.querySelector('input[type="checkbox"]');
    const memo = tr.querySelector('input[type="text"]');
    const btn  = tr.querySelector('button');

    const save=()=>{
      const rec={
        key,
        action: sel.value,
        resolved: chk.checked,
        memo: memo.value.trim(),
        who: hr||'',
        ts: new Date().toISOString()
      };
      upsertAction(rec);
      btn.textContent='저장됨';
      setTimeout(()=>btn.textContent='저장',800);

      renderAdmin();
      updateKPIs();
    };

    tr.addEventListener('keydown',e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        save();
      }
      if(e.altKey && (e.key==='c'||e.key==='C')){
        chk.checked=!chk.checked;
      }
    });

    btn.onclick=save;
    tbody.appendChild(tr);
  });
}

/* 관리자 화면 */
function renderAdmin(){
  const tbody=document.getElementById('tbodyAdmin');
  tbody.innerHTML='';

  const filter=document.getElementById('filterStatus').value;
  const q=(document.getElementById('searchAdmin').value||'').trim().toLowerCase();

  const rows=ACTIONS.map(a=>{
    const [ymd,name,cls,subj]=a.key.split('|');
    const teacher = RAW.find(r=>
      fmtYMD(parseDate(r['날짜']))===ymd &&
      r['학생명']===name &&
      r['반코드']===cls &&
      r['과목']===subj
    )?.['작성자'] || '';
    return {...a,ymd,name,cls,subj,teacher};
  }).filter(x=>{
    if(filter==='open' && x.resolved) return false;
    if(filter==='resolved' && !x.resolved) return false;
    const text=`${x.ymd} ${x.name} ${x.cls} ${x.subj} ${x.teacher} ${x.action} ${x.memo}`.toLowerCase();
    if(q && !text.includes(q)) return false;
    return true;
  }).sort((a,b)=>(b.ts||'').localeCompare(a.ts||''));

  rows.forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="px-2 py-1">${x.ts?x.ts.replace('T',' ').slice(0,16):''}</td>
      <td class="px-2 py-1">${x.ymd}</td>
      <td class="px-2 py-1">${x.name}</td>
      <td class="px-2 py-1">${x.cls}</td>
      <td class="px-2 py-1">${x.subj}</td>
      <td class="px-2 py-1">${x.teacher}</td>
      <td class="px-2 py-1">${x.action}</td>
      <td class="px-2 py-1">${x.resolved?'확인':''}</td>
      <td class="px-2 py-1">${x.memo}</td>
    `;
    tbody.appendChild(tr);
  });

  // 위험 학생
  const risk=buildStudentRates().filter(s=>s.rate<=70).sort((a,b)=>a.rate-b.rate);
  const riskUL=document.getElementById('riskList');
  riskUL.innerHTML='';
  if(!risk.length){
    riskUL.innerHTML='<li class="text-slate-400">(없음)</li>';
  }else{
    risk.forEach(s=>{
      const li=document.createElement('li');
      li.innerHTML=`
        <span class="font-semibold">${s.name}</span>
        <span class="text-slate-500 ml-1">${s.classes.join(', ')}</span>
        <span class="badge badge-amber ml-1">${s.rate}%</span>
      `;
      riskUL.appendChild(li);
    });
  }

  // 타임라인
  const tl=document.getElementById('timeline');
  tl.innerHTML='';
  ACTIONS.slice().sort((a,b)=>(b.ts||'').localeCompare(a.ts||'')).slice(0,20).forEach(a=>{
    const [ymd,name,cls,subj]=a.key.split('|');
    const div=document.createElement('div');
    div.className='border rounded p-2';
    div.innerHTML=`
      <div class="text-xs text-slate-500">${a.ts?a.ts.replace('T',' ').slice(0,16):''}</div>
      <div>
        <span class="font-semibold">${name}</span> · ${cls} · ${subj}
        <span class="badge">${a.action||'-'}</span>
        ${a.resolved?'<span class="badge badge-green ml-2">확인</span>':''}
      </div>
      ${a.memo?`<div class="text-sm text-slate-600 mt-1">메모: ${a.memo}</div>`:''}
    `;
    tl.appendChild(div);
  });
}

/* KPI */
function updateKPIs(){
  const missCnt=RAW.filter(r=>normalizeStatus(r['상태'])==='미수행' && inRangeDate(parseDate(r['날짜']))).length;
  const openCnt=ACTIONS.filter(a=>!a.resolved).length;
  const resolvedCnt=ACTIONS.filter(a=>a.resolved).length;
  const riskCnt=buildStudentRates().filter(s=>s.rate<=70).length;

  document.getElementById('kpiMiss').textContent=missCnt;
  document.getElementById('kpiOpen').textContent=openCnt;
  document.getElementById('kpiResolved').textContent=resolvedCnt;
  document.getElementById('kpiRisk').textContent=riskCnt;
}

/* CSV 내보내기 / 불러오기 */
function exportCSV(){
  const header=['key','action','resolved','memo','who','ts'];
  const rows=ACTIONS.map(a=>({
    key:a.key,
    action:a.action,
    resolved:a.resolved?1:0,
    memo:a.memo||'',
    who:a.who||'',
    ts:a.ts||''
  }));
  const ws=XLSX.utils.json_to_sheet(rows,{header});
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'interventions');
  const out=XLSX.write(wb,{type:'array',bookType:'csv'});
  const blob=new Blob([out],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='interventions.csv'; a.click();
  URL.revokeObjectURL(url);
}

async function importInterventionsFromFile(file){
  let arr=[];
  if(/\.csv$/i.test(file.name)){
    const text=await file.text();
    const wb=XLSX.read(text,{type:'string'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    arr=XLSX.utils.sheet_to_json(ws,{defval:''});
  }else{
    const buf=await file.arrayBuffer();
    const wb=XLSX.read(buf,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    arr=XLSX.utils.sheet_to_json(ws,{defval:''});
  }
  arr.forEach(o=>{
    if(!o.key) return;
    const rec={
      key:String(o.key),
      action:String(o.action||''),
      resolved:String(o.resolved)==='1' || String(o.resolved).toLowerCase()==='true',
      memo:String(o.memo||''),
      who:String(o.who||''),
      ts:String(o.ts||'')
    };
    upsertAction(rec);
  });
  renderAdmin();
  updateKPIs();
  alert('조치 기록을 병합했습니다.');
}

/* 전체 렌더 */
function renderAll(){
  const sel=document.getElementById('homeroom');
  const uniq=Array.from(new Set(
    RAW.map(r=>String(r['작성자']||'').trim()).filter(v=>v!=='')
  )).sort((a,b)=>a.localeCompare(b,'ko'));
  const cur=sel.value;
  sel.innerHTML='<option value="">담임: 전체</option>'+uniq.map(v=>`<option value="${v}">${v}</option>`).join('');
  if(uniq.includes(cur)) sel.value=cur;

  const mode=document.getElementById('mode').value;
  document.getElementById('page-teacher').classList.toggle('hidden',mode!=='teacher');
  document.getElementById('page-admin').classList.toggle('hidden',mode!=='admin');

  if(mode==='teacher') renderTeacher();
  else                 renderAdmin();

  updateKPIs();
}

/* 이벤트 바인딩 */
function bindEvents(){
  const startDate=document.getElementById('startDate');
  const endDate=document.getElementById('endDate');

  const savedS=localStorage.getItem('lancon_range_start');
  const savedE=localStorage.getItem('lancon_range_end');
  if(savedS) startDate.value=savedS;
  if(savedE) endDate.value=savedE;
  updateBadge();

  document.getElementById('mode').onchange=renderAll;

  document.getElementById('homeroom').onchange=()=>{
    const hr=document.getElementById('homeroom').value;
    localStorage.setItem('lancon_selected_teacher',hr||'');
    saveRange();
    if(document.getElementById('mode').value==='teacher')
      renderTeacher();
  };

  document.getElementById('searchTeacher').oninput=()=>{
    if(document.getElementById('mode').value==='teacher') renderTeacher();
  };

  document.getElementById('searchAdmin').oninput=()=>{
    if(document.getElementById('mode').value==='admin') renderAdmin();
  };

  document.getElementById('filterStatus').onchange=()=>{
    if(document.getElementById('mode').value==='admin') renderAdmin();
  };

  startDate.onchange=()=>{updateBadge();saveRange();renderAll();};
  endDate.onchange  =()=>{updateBadge();saveRange();renderAll();};

  document.getElementById('rngAll').onclick=()=>{
    startDate.value=''; endDate.value='';
    updateBadge(); saveRange(); renderAll();
  };

  document.getElementById('rngToday').onclick=()=>{
    const d=new Date();
    const s=fmtYMD(d);
    startDate.value=s; endDate.value=s;
    updateBadge(); saveRange(); renderAll();
  };

  document.getElementById('rngWeekMon').onclick=()=>{
    const d=new Date();
    const day=(d.getDay()+6)%7;
    const s=new Date(d); s.setDate(d.getDate()-day);
    const e=new Date(s); e.setDate(s.getDate()+6);
    startDate.value=fmtYMD(s); endDate.value=fmtYMD(e);
    updateBadge(); saveRange(); renderAll();
  };

  document.getElementById('rngMonth').onclick=()=>{
    const d=new Date();
    const s=new Date(d.getFullYear(),d.getMonth(),1);
    const e=new Date(d.getFullYear(),d.getMonth()+1,0);
    startDate.value=fmtYMD(s); endDate.value=fmtYMD(e);
    updateBadge(); saveRange(); renderAll();
  };

  document.getElementById('rngLastWeek').onclick=()=>{
    const d=new Date();
    const day=(d.getDay()+6)%7;
    const e=new Date(d); e.setDate(d.getDate()-day-1);
    const s=new Date(e); s.setDate(e.getDate()-6);
    startDate.value=fmtYMD(s); endDate.value=fmtYMD(e);
    updateBadge(); saveRange(); renderAll();
  };

  document.getElementById('rngLastMonth').onclick=()=>{
    const d=new Date();
    const s=new Date(d.getFullYear(),d.getMonth()-1,1);
    const e=new Date(d.getFullYear(),d.getMonth(),0);
    startDate.value=fmtYMD(s); endDate.value=fmtYMD(e);
    updateBadge(); saveRange(); renderAll();
  };

  document.getElementById('autoLoad').onchange=()=>{
    localStorage.setItem(LS_KEYS.autoload, autoLoad.checked?'1':'0');
    if(autoLoad.checked && RAW.length) saveToLocal(RAW);
  };

  document.getElementById('clearSaved').onclick=()=>{
    localStorage.removeItem(LS_KEYS.data);
    localStorage.removeItem(LS_KEYS.actions);
    alert('저장된 데이터(본 데이터 + 조치기록)를 삭제했습니다.');
  };

  document.getElementById('fileInput').onchange=async(e)=>{
    const f=e.target.files[0];
    if(!f) return;
    const parsed=await parseFile(f);
    RAW=(parsed||[])
      .map(mapRecord)
      .filter(r=>Object.values(r).some(v=>String(v??'').trim()!==''));
    if(document.getElementById('autoLoad').checked) saveToLocal(RAW);
    renderAll();
  };

  document.getElementById('btnReloadExample').onclick=()=>loadFromServer();
  document.getElementById('btnExport').onclick = exportCSV;
  document.getElementById('importInterventions').onchange = (e)=>{
    const f=e.target.files[0];
    if(f) importInterventionsFromFile(f);
  };

  // 인쇄 버튼
  document.getElementById("btnPrintMiss").onclick = () => {
    const hr = document.getElementById("homeroom").value || "";
    localStorage.setItem("lancon_selected_teacher", hr);

    const s = document.getElementById("startDate").value;
    const e = document.getElementById("endDate").value;
    localStorage.setItem("lancon_range_start", s);
    localStorage.setItem("lancon_range_end", e);

    window.open("print_miss.html?auto=1", "_blank");
  };
}

/* 초기 실행 */
document.addEventListener('DOMContentLoaded',()=>{
  loadActions();
  bindEvents();

  if(!loadFromLocal()) loadFromServer();
  else renderAll();
});
</script>

</body>
</html>
